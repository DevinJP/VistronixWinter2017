<html>
<head>
    <title>Intern Project</title>
<script type='text/javascript' src='http://js.do/blog/wp-includes/js/jquery/jquery.js?ver=1.11.2'></script>
<script type='text/javascript' src='http://js.do/blog/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
</head>
<script>
$ = jQuery;
</script>
<div style="background-color: lightblue; text-align: center; padding-top: 0;">
    <h1>Winter Intern Project</h1>
</div>

<style type="text/css">
body {
    background-color: lightgrey;
    font-family: 'Lucida Console', Monaco, monospace;
    color: #000000;
}
div.scroll{
	width:920px;
	height:318px;
	overflow-y: scroll;
}
.text-box{
	white-space: pre-line;
}

div.test { background-color: #3498DB; padding:5px;width:140;border-style: solid;}
.freqLabel {
    background-color:#CCC;
    width:70;
}
.modLabel {
    background-color:#DDD;
    min-width:80;
}
.numLabel {
  background-color:#DDD;
    min-width:50;
	border-style: solid;
}
.menubutton{
	white-space: nowrap;
	display: inline-block;
	border-radius: 4px;
	background-color: darkgrey;
	font-size: 20px;
}
#mediaContainer {
	width: 100%;
	display: inline-block;
	white-space: nowrap;
}
.statusBoxes {
	height: 55;
	width: 450px;
	font-size: 35;
	text-align: center;
	background-color: red;
	padding: 10px;
	border-style: solid 1px;
}
</style>

<body>
<audio id="audio" src="" type="audio/wav"></audio>
<div>
	<input type="button" disabled onclick="changePlay()" value="Pause" id= "playButton" class="menubutton"/>
	<input type="button" onclick="changeMute()" value="Mute" id= "muteButton" class="menubutton"/>
	<input type="button" onclick="start()" value="Radio" id= "radioButton" class="menubutton"/>
	<input type="button" onclick="startComms()" value ="Start Comms" id ="startCommsButton" class="menubutton"/>
	<input type="button" onclick="killComms()" value ="Kill Comms" id ="killCommsButton" class="menubutton"/>
	<input type="button" onclick="startApp()" value ="Start App" id ="startAppButton" class="menubutton"/>
        <input type="button" onclick="killApp()" value ="Kill App" id ="killAppButton" class="menubutton"/>
	<p id = "playingLabel">Choose Channel</p>
</div>
<div id="mediaContainer">
<table cellpadding="0" style="float: left;">
<tr>
<td>
<div class="test">Channel 1
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">100</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('100')" value="1">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 2
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">200</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('200')" value="2">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 3
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">300</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('301')" value="3">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 4
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">400</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('401')" value="4">Listen</button></td>
    </tr>
</table></div>
</td>
</tr><tr>
<td>
<div class="test">Channel 5
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">500</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('500')" value="5">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 6
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">600</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('601')" value="6">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 7
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">700</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('700')" value="7">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 8
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">800</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('800')" value="8">Listen</button></td>
    </tr>
</table></div>
</td>
</tr><tr>
<td>
<div class="test">Channel 9
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">900</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('900')" value="9">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 10
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1000</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1000')" value="10">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 11
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1100</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1100')" value="11">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 12
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1200</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1200')" value="12">Listen</button></td>
    </tr>
</table></div>
</td>
</tr><tr>
<td>
<div class="test">Channel 13
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1300</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1300')" value="13">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 14
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1400</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1400')" value="14">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 15
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1500</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1500')" value="15">Listen</button></td>
    </tr>
</table></div>
</td><td>
<div class="test">Channel 16
<table cellpadding="0" cellspacing="0">
    <tr>
        <td class="freqLabel">Freq</td>
		<td class="numLabel">N/A</td>
    </tr><tr>
        <td class="modLabel">Mod</td>
		<td class="numLabel">1600</td>
    </tr><tr>
		<td><button type="button" onclick="updatevar('1600')" value="16">Listen</button></td>
    </tr>
</table></div>
</td>
</tr>
</table>
<canvas class="round10" id="canvas2" style="background-color: #333333; position: relative; float: right;" width="1000" height="450" ></canvas>
</div>
<table style="float:right; background-color: grey;">
    <tr><td><div class="statusBoxes" style="font-size: 35px; background-color: grey;">Network Status</div></td></tr>
    <tr><td>
        <div class="statusBoxes" id="domzero">Dom0</div>
    </td></tr>
    <tr><td>
	<div class="statusBoxes" id="comms">Comms VM</div>
    </td></tr>
    <tr><td>
        <div class="statusBoxes" id="app">Application VM</div>
    </td></tr>
</table>
<div id='fileContainer' class="scroll text-box"></div>
<script type="text/javascript">
var freq;
var channel;
var dir = new URL("http://10.19.100.219:8080/");
var serverDir = new URL("http://10.19.100.170:8080/");
var updateDom0 = window.setInterval(updateDom0, 10000);
var updateComms = window.setInterval(updateComms, 10000);
var updateApp = window.setInterval(updateApp, 10000);
function updatevar(name){
	freq = name;
	updatesrc(freq);
	draw_and_play(name);
}
function updatesrc(name) {
	 var fileContainer = document.getElementById('fileContainer');
          var xhr = new XMLHttpRequest();
          xhr.onload = function () {
             fileContainer.innerHTML = this.response;
        };

           xhr.open('GET', dir+'health-kali?'+(new Date).getTime(), true);
           xhr.send();

        var audio = document.getElementById('audio');
        audio.src=dir+name;
        audio.play(); //call this to play the song right away
		document.getElementById('playButton').disabled = false;
		document.getElementById("playingLabel").innerHTML ="Playing Channel " + Math.floor(freq/100); 
}
audio.addEventListener("ended", function(){
	audio.currentTime=0;
	updatesrc(freq)
}, false);
function changeMute()
{
    var elem = document.getElementById("muteButton");
    if (elem.value=="Mute") elem.value = "Unmute";
    else elem.value = "Mute";
	document.getElementById("audio").muted=!document.getElementById("audio").muted;
}
function changePlay()
{
    var elem = document.getElementById("playButton");
    if (elem.value=="Play"){
			elem.value = "Pause";
			audio.play();
    }else{
		elem.value = "Play";
		audio.pause();
		
	}
}
function startComms(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", serverDir + "start-comms", true );
        xmlHttp.send();
}
function killComms(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", serverDir + "kill-comms", true );
        xmlHttp.send();
}
function start(){
	 var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", dir + "start", true );
	xmlHttp.send();
	audio.pause();
	var elem = document.getElementById("playButton");
	elem.disabled = true;
	elem.value ="Pause";
        document.getElementById("playingLabel").innerHTML ="Choose Channel";
	
}
function startApp(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", dir + "start-app", true );
        xmlHttp.send();
}
function killApp(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", dir + "kill-app", true );
        xmlHttp.send();
}
function updateDom0(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", serverDir + "dom0", true );
        xmlHttp.send();
	
	xmlHttp.onreadystatechange=function(){
		if (xmlHttp.status==200){
			document.getElementById("domzero").style.backgroundColor = "green";
		}else if (xmlHttp.status==409){
			document.getElementById("domzero").style.backgroundColor = "red";
		}
	}
}
function updateComms(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", serverDir + "comms", true );
        xmlHttp.send();
        
        xmlHttp.onreadystatechange=function(){
                if (xmlHttp.status==200){
                        document.getElementById("comms").style.backgroundColor = "green";
                }else if(xmlHttp.status==409){
                        document.getElementById("comms").style.backgroundColor = "red";
                }
        }
}
function updateApp(){
	var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", dir + "app", true );
        xmlHttp.send();
        
        xmlHttp.onreadystatechange=function(){
                if (xmlHttp.status==200){
                        document.getElementById("app").style.backgroundColor = "green";
                }else if(xmlHttp.status==409){
                        document.getElementById("app").style.backgroundColor = "red";
                }else {
			document.getElementById("app").style.backgroundColor = "red";
		}		
        }
}
</script>
<script>


var  PI=Math.PI,

     pi=Math.PI,

    abs=Math.abs,

    sin=Math.sin,

  floor=Math.floor,

   ceil=Math.ceil,

    max=Math.max,

    min=Math.min,

 random=Math.random,

  round=Math.round,

   sqrt=Math.sqrt,

    exp=Math.exp,

    log=Math.log,

    pow=Math.pow;



$(document).ready(function () {



 global={

  play_ids: [],

  play_canvas_ids: [],

  play_element: [],

  last_play_n: '',

 };

});



function draw_and_play(freq) {



  sampleRate = 44100;


  var samples = [] //new Float32Array(samples_length);

  try {
	var frequency = freq;                      // 220 Hz = "A" note

	var samples_length = 44100;               // Plays for 1 second (44.1 KHz)

	for (var i=0; i < samples_length ; i++) { // fills array with samples

  	var t = i/samples_length;               // time from 0 to 1

 	samples[i] = sin( frequency * 2*PI*t ); // wave equation (between -1,+1)
	}
  } catch (e) {

    result_error = 'ERROR: '+e;

    alert(result_error);

  }



  if (samples.length==0) {

    alert("ERROR: No values in array 'samples'");

    return;

  }


  normalize_invalid_values(samples); // keep samples between [-1, +1]



  draw_canvas_graph(samples);


}



function normalize_invalid_values(samples) {

  for (var i=0, len=samples.length; i<len; i++) {

    if (samples[i]>1) {

      samples[i] = 1;

    } else if (samples[i]<-1) {

      samples[i] = -1;

    }

  }

}



function draw_canvas_graph(samples) {


  if (global.play_canvas_id) {

    clearInterval(global.play_canvas_id);

  }

  if (global.play_canvas2_id) {

    clearInterval(global.play_canvas2_id);

  }


  var canvas2 = document.getElementById('canvas2');



  var canvas = document.getElementById('canvas1');

  var canvas_width = canvas2.width;


  
  if (canvas2.getContext) {

    var amplitude = canvas2.height/2-20;

    var iter=0;

    var last_iter_draw=-1;


    var play_duration_ms = samples.length * 1000 / sampleRate; // 44100*1000/44100 = 1000 ms (1 s.)


    var interval_ms = Math.round(canvas_width * play_duration_ms / samples.length); // 882*500/22050 = 20 ms

    var step = 2; // 1 = 50 frames per second


    var number_of_iters = Math.floor(samples.length / canvas_width); // round removing last pixels if samples.length not divisable by canvas.width 

    var middle_iter = Math.round(number_of_iters/2);



    var hsl_factor = 50/number_of_iters; // Max fading hsl 's' = 50%



    global.play_canvas2_id = setInterval(function() {


      if (iter==middle_iter) { // iter==0 would draw the first samples.

        if (canvas2.getContext) {

          var context2 = canvas2.getContext('2d');

          clearCanvas(context2, canvas2);

          var canvas2_width = canvas2.width;

          var canvas2_height = canvas2.height;



          // Draw background graphic grid

          context2.fillStyle = '#131';

          context2.fillRect(0, Math.round(canvas2_height/2), canvas2_width, 1);



          context2.fillStyle = 'hsl(127,83%,66%)'; // green #60f070

          var x2=0;



          global.play_canvas2_id = setInterval( function() {

            var y = Math.round((canvas2_height/2)-samples[x2+middle_iter*canvas_width]*amplitude);

            context2.fillRect(x2, y, 1, 1);

            x2++;

            if (x2>= canvas2_width) {

              clearInterval(global.play_canvas2_id);

            }

          }, 1);


        }

      }



      if (iter%step==0) {



        // Clear last graph

        if (last_iter_draw>=0) {

         for (var x=0; x<=canvas_width; x++) {

           var sample_pos = x+((last_iter_draw)*canvas_width);

           var y = (canvas.height/2)-samples[sample_pos]*amplitude;

           context.fillStyle = 'hsl(127,13%,'+iter+'%)'; // fading effect

           last_fillStyle = context.fillStyle;

           context.fillRect(x, y, 1, 1);

         }

       }



       var pos_offset = iter*canvas_width;


      }



      iter++;

    }, interval_ms); // End of setInterval



  }



}



function clearCanvas(context, canvas) {

  var w = canvas.width;

  context.clearRect(0, 0, w, canvas.height);

  canvas.width = 1;

  canvas.width = w;

  context.fillStyle = '#7f7';

}



function convert255(data) {

  var data_0_255=[];

  for (var i=0;i<data.length;i++) {

    data_0_255[i]=128+Math.round(127*data[i]);

  }

  return data_0_255;
}
</script>
</body> 
</html>
